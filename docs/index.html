<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.16
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1>A social network tool with your clients for your business</h1>

<p><img src=public/images/doc/colibri_front.png>
This application can also be qualified as a Ruby on Rails SharingFile System</p>

<p>If you deliver files and documents to your clients and if you want to record your clients&#39;satisfaction, this tool is for you</p>

<p>If you are a developper, check online class documentation :
<a href="https://alexandrecuer.github.io/sharebox/">https://alexandrecuer.github.io/sharebox/</a></p>

<p><a href="https://travis-ci.org/alexandrecuer/sharebox"><img src="https://travis-ci.org/alexandrecuer/sharebox.svg?branch=master" alt="Build Status"></a></p>

<p>Check online prototype : <a href="https://desolate-earth-32333.herokuapp.com/">https://desolate-earth-32333.herokuapp.com/</a></p>

<p>Uses the following gems :</p>

<ul>
<li><a href="https://github.com/thoughtbot/paperclip">paperclip</a> for documents processing</li>
<li><a href="https://github.com/plataformatec/devise">devise</a> for user authentification</li>
<li><a href="https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/heroku/standalone/oss/deploy_app_main.html">passenger</a> as the application server (in standalone mode)</li>
<li><a href="https://github.com/aws/aws-sdk-ruby">aws-sdk</a> for storage on S3</li>
<li><a href="https://github.com/twbs/bootstrap-rubygem">bootstrap</a> as the frontoffice framework</li>
<li><a href="https://github.com/bokmann/font-awesome-rails">font-awesome</a> for icons and cosmectic details</li>
</ul>

<h2>Will have to switch from paperclip to <a href="http://guides.rubyonrails.org/active_storage_overview.html">ActiveStorage</a> as paperclip is now deprecated</h2>

<h1>Deployment to Heroku through GitHub integration</h1>

<p>This application has been designed for an automatic deployment from github to the heroku cloud
You will need a S3 bucket as Heroku has an ephemeral file system</p>

<h2>Fork and customize the repository to your needs</h2>

<p>Assuming you have a GitHub account and you are logged in, fork the sharebox repository into your GitHub account</p>

<p><img src=public/images/doc/01_fork.png></p>

<p>To customize the application to your needs, edit the following files </p>

<ul>
<li>config/config.yml</li>
<li>config/initializers/devise.rb</li>
</ul>

<p><img src=public/images/doc/02_customization.png></p>

<p>You have to setup the following parameters :</p>

<ul>
<li>in config.yml, site_name and admin_mel</li>
<li>in devise.rb, config.mailer_sender</li>
</ul>

<p>admin_mel will receive activity notifications : new shares, pending users. Pending users are unregistered users benefiting from at least one shared access to a folder</p>

<p>config.mailer_sender will be the sending email as far as authentification issues are considered (eg password changes)</p>

<p>You can find the two site’s logos in the /app/assets/images directory </p>

<p><img src=public/images/doc/03_site_logos.png></p>

<p>colibri.jpg is the main logo appearing above the login box</p>

<p>logo.jpg is the logo used in emails sent by private users to public users</p>

<p>The sharebox repository Gemfile may suggest a ruby version not suitable with the recommanded heroku stack, that is to say created with a deprecated heroku stack</p>

<p>For the heroku-18 stack, please note you will  have to proceed to the following modifications</p>

<ul>
<li>in the Gemfile, change <code>ruby &#39;2.3.3&#39;</code> to <code>ruby &#39;2.5.1&#39;</code></li>
<li>in the Gemfile.lock, RUBY VERSION section, change <code>ruby 2.3.3p222</code> to <code>ruby 2.5.1p57</code></li>
</ul>

<h2>Create a new Heroku app and link it to the GitHub repository previously forked</h2>

<p>Create an heroku account if you do not have one yet, and once logged in, access to the heroku dashboard in order to create a new heroku app, here named « cerema-autun »</p>

<p><img src=public/images/doc/04_create_app.png></p>

<p>Once the application is created, you will be redirected to the application control panel</p>

<p>Go to the deploy tab and choose the GitHub deployment method (Please note you need to be logged into your GitHub account)</p>

<p><img src=public/images/doc/05_connect_to_github_1.png></p>

<p><img src=public/images/doc/06_connect_to_github_2.png></p>

<p>Your GitHub and heroku accounts are now linked together.</p>

<h2>Fill all the needed config variables</h2>

<p>Before proceeding to a deployment, fill all the needed config vars.</p>

<p>11 config vars are needed by the sharebox application and if one is missing, the deployment will fail.</p>

<p><img src=public/images/doc/07_config_vars.png></p>

<p>If the bucket does not exist, it will be created when the first file will be uploaded to S3.</p>

<p>Everything is ready for a manual deploy.</p>

<h2>Proceed to a manual deploy</h2>

<p><img src=public/images/doc/08_manual_deploy.png></p>

<p>The manual deploy will initialize the missing config variables, related to Heroku and create an empty database. 
Just create the database tables with a rake db:schema:load command in the Heroku console and your app is on line.</p>

<p><img src=public/images/doc/09_create_table.png></p>

<p>Please note that the first user to register in the system will be given admin rights !!</p>

<h1>Installation on a Microsoft Window development machine</h1>

<h2>Requirements</h2>

<p>Window All-In-One rails installer <a href="http://railsinstaller.org/en">Ruby on Rails</a> &gt;= 5.1.4 + NodeJS</p>

<p><a href="http://www.imagemagick.org">ImageMagick</a> for documents processing</p>

<p>Gem file is configured to use postgreSQL, so please install PGQSL window binary
<a href="https://www.enterprisedb.com/">EDB POSTGRES</a></p>

<p>If you want to use another DBMS, you will have to change the gem file</p>

<h3>Rails</h3>

<p>After having run RailsInstaller, launch a git bash, verify ruby version <code>ruby -v</code>, install Rails <code>gem install rails</code> and verify the version :</p>

<pre class="code ruby"><code class="ruby">$ rails -v
Rails 5.1.5
</code></pre>

<p>Check you can create a new application named blog <code>rails new blog</code></p>

<p>The system will create the app files and launch the command <code>bundle install</code> to fetch some gems</p>

<p>Launch the server with the command <code>rails server</code>. The server should be up on port 3000. Browse the adress <a href="http://localhost:3000">http://localhost:3000</a> in Mozilla.</p>

<h3>ImageMagick</h3>

<p>For a more detailed procedure, check <a href="https://github.com/thoughtbot/paperclip#requirements">https://github.com/thoughtbot/paperclip#requirements</a></p>

<p>ImageMagick uses two utilities file.exe and convert.exe</p>

<p>You will have to install file.exe from <a href="http://gnuwin32.sourceforge.net/packages/file.htm">gnuwin32</a></p>

<p>When you install ImageMagick, don&#39;t forget to include the required legacy utilities among which you will find convert.exe</p>

<p><img src=public/images/doc/imagemagick.png height=300></p>

<p>Modify the system and user paths so that they begin with something like C:\Program Files\ImageMagick-7.0.6-Q16\ and C:\Program Files (x86)\GnuWin32.</p>

<p>On windows 10, from the control panel :
<code>
Security and System &gt; System &gt; Advanced System Parameters &gt; Environment Variables
</code></p>

<p>Please note Window has got its own convert utility. Paperclip will not work with the Window convert.exe. ImageMagick&#39;s convert.exe should come first</p>

<pre class="code ruby"><code class="ruby">$ where convert
c:\Program Files\ImageMagick-7.0.6-Q16\convert.exe
c:\Windows\System32\convert.exe
</code></pre>

<p>Check if everything is OK in the rails git bash :</p>

<pre class="code ruby"><code class="ruby">$ which file
/c/Program Files (x86)/GnuWin32/bin/file
$ which convert
/c/Program Files/ImageMagick-7.0.6-Q16/convert
</code></pre>

<h3>NodeJS</h3>

<p>Install <a href="https://nodejs.org/en/download/">NodeJS</a></p>

<h2>Installation</h2>

<p>Clone/Unzip the repository into your local rails directory, for example C:/Sites/. 
Open the resulting app directory in a git bash </p>

<pre class="code ruby"><code class="ruby">$ cd /c/Sites/sharebox
</code></pre>

<p>Install the required gems <code>$ bundle install</code> or <code>$ bundle update</code></p>

<p>Please note that the bcrypt gem needed for devise may malfunction.
To correct, you have to reinstall manually</p>

<pre class="code ruby"><code class="ruby">$ gem uninstall bcrypt
$ gem uninstall bcrypt-ruby
$ gem install bcrypt --platform=ruby
</code></pre>

<h3>Setting environmental variables</h3>

<p>The application uses several variables, which you have to fix in the environment</p>

<table><tr><td valign=top>For S3 storage
<table>
    <tr>
        <td><sub>S3_BUCKET_NAME</sub></td>
        <td><sub><a href=https://devcenter.heroku.com/articles/s3#s3-setup>Heroku specific doc</a></sub></td>
    </tr>
    <tr>
        <td><sub>AWS_REGION</sub></td>
        <td rowspan=2><sub><a href=https://docs.aws.amazon.com/fr_fr/general/latest/gr/rande.html#s3_region>AWS regional parameters</a><br><sub> ex : AWS_REGION=eu-west-3 and AWS_HOST_NAME=s3.eu-west-3.amazonaws.com</sub></sub></td> 
    </tr>
    <tr>
        <td><sub>AWS_HOST_NAME</sub></td>
    </tr>
    <tr>
        <td><sub>AWS_URL</sub></td>
        <td><sub>S3_BUCKET_NAME.AWS_HOST_NAME</sub></td>
    </tr>
    <tr>
        <td><sub>AWS_ACCESS_KEY_ID</sub></td>
        <td rowspan=2><sub><a href=https://console.aws.amazon.com/iam/home#/users>IAM - Identity and Access Management</a></sub></td>
    </tr>
    <tr>
        <td><sub>AWS_SECRET_ACCESS_KEY</sub></td>
    </tr>
</table>

<p></td><td valign=top>For Mail delivery</p>

<table>
    <tr>
        <td><sub>GMAIL_USERNAME</sub></td>
        <td rowspan=2><sub><a href=https://mail.google.com/>gmail</a></sub></td>
    </tr>
    <tr>
        <td><sub>GMAIL_PASSWORD</sub></td>
    </tr>
    <tr>
        <td><sub>SMTP_ADDRESS</sub></td>
        <td rowspan=2><sub>example if using gmail :<br><sub>SMTP_ADDRESS="smtp.gmail.com" and SMTP_PORT=587</sub></sub></td>
    </tr>
    <tr>
      <td><sub>SMTP_PORT</sub></td>
    </tr>
    <tr>
      <td><sub>DOMAIN</sub></td>
      <td><sub>In development mode :<br><sub>localhost</sub><br>For a production server :<br><sub>ip address or domain name of the server</sub></sub></td>
    </tr>
</table>

<p></td></tr></table></p>

<h5>First option</h5>

<p>Edit the set_env_var.bat file, fill it with your personal credentials and run this bat file from the main DOS shell. It will fix the environment details in all subsequent shells such as git bash or window power shell. You can start the server from a git bash with the classic method :</p>

<pre class="code ruby"><code class="ruby">$ rails server
</code></pre>

<h5>Second option</h5>

<p>On Windows, this second option may permit to override specific problems related to environment variables beginning with /. Edit the .env file and fill it with your personal credentials. Install <a href="https://github.com/strongloop/node-foreman">node-foreman</a> and start the server from a git bash with the following command :</p>

<pre class="code ruby"><code class="ruby">$ nf -p 3000 start -s -j Procfile_dev
</code></pre>

<h3>Database configuration</h3>

<p>Modify the \config\environments\database.yml with your database credentials. 
Generally, the postgreSQL Window installer creates a user &quot;postgres&quot; for which you were asked a password during the installation process. </p>

<pre class="code ruby"><code class="ruby">default: &amp;default
  adapter: postgresql
  encoding: unicode
  # For details on connection pooling, see Rails configuration guide
  # http://guides.rubyonrails.org/configuring.html#database-pooling
  pool: &lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;
  username: postgres
  password: your_pass
  host: localhost
</code></pre>

<p>Create the database and the tables</p>

<pre class="code ruby"><code class="ruby">$ rake db:create
$ rails db:migrate
</code></pre>

<p>To create the database structure and the tables, you don&#39;t have to run all the migrations from scratch :</p>

<pre class="code ruby"><code class="ruby">$ rails db:schema:load
</code></pre>

<h2>File storage</h2>

<p>Document storage is configured for : </p>

<ul>
<li>Amazon S3 in production mode </li>
<li>local file system in development mode. In that case, the aws-sdk gem is not used.</li>
</ul>

<p>Switching between S3 mode and local storage mode can be done by modifying the value of config.local_storage </p>

<ul>
<li>in /config/environments/development.rb </li>
<li>and in /config/environments/production.rb</li>
</ul>

<p>with config.local_storage = 1, local storage will be activated<br>
with config.local_storage = 0, all files will go in the defined S3 bucket</p>

<table>
  <tr>
    <td></td>
    <td valign=top>S3 storage</td>
    <td valign=top>local storage</td>
  </tr>
  <tr>
    <td>\config\environments\developpment.rb</td>
    <td width=50%><sub>
      config.paperclip_defaults = {<br>
        storage: :s3,<br>
        s3_credentials: {<br>
          bucket: ENV.fetch('S3_BUCKET_NAME'),<br>
          access_key_id: ENV.fetch('AWS_ACCESS_KEY_ID'),<br>
          secret_access_key: ENV.fetch('AWS_SECRET_ACCESS_KEY'),<br>
          s3_region: ENV.fetch('AWS_REGION'),<br>
          s3_host_name: ENV.fetch('AWS_HOST_NAME'),<br>
        }<br>
      }
      </sub>
    </td>
    <td></td>
  </tr>
  <tr>
    <td>\app\models\asset.rb</td>
    <td width=50%><sub>
      has_attached_file :uploaded_file,<br>
      url: ENV.fetch('AWS_URL'),<br>
      path: '/forge/attachments/:id/:filename',<br>
      s3_permissions: :private
      </sub>
    </td>
    <td width=50%><sub>
      has_attached_file :uploaded_file,<br>
      url: '/forge/get/:id/:filename',<br>      
      path: ':rails_root/forge/attachments/:id/:filename'<br>
      </td>
  </tr>
  <tr>
    <td>\app\controllers\assets_controller.rb</td>
    <td><sub>
      redirect_to asset.uploaded_file.expiring_url(10)
      </sub>
    </td>
    <td><sub>
      send_file asset.uploaded_file.path, :type => asset.uploaded_file_content_type
      </sub>
    </td>
  </tr>
</table>

<h3>Use Amazon S3</h3>

<p>You may encounter difficulties due to some SSL defaults on your development machine.</p>

<p>To override, create a file /config/initializers/paperclip.rb with the following command</p>

<pre class="code ruby"><code class="ruby"><span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_PEER</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_NONE</span>
</code></pre>

<p>Caution : only for a development purpose; not suitable for a production server !</p>

<h1>Configuring mail services</h1>

<p>Assuming you are using gmail for mail delivery, you may need to configure your google account in order to allow external applications to use it </p>

<p><img src=public/images/doc/gmail_less_secure_apps.png></p>

<p><a href="https://www.google.com/settings/security/lesssecureapps">https://www.google.com/settings/security/lesssecureapps</a></p>

<p>On a production server, it may be necessary to clear the captcha in order to define the production server as an authorized application with auto sign-in activated</p>

<p><a href="https://accounts.google.com/DisplayUnlockCaptcha">https://accounts.google.com/DisplayUnlockCaptcha</a></p>

<p>The captcha is cleared for a few minutes. During that time, you can realize a password modification in order for your production server to be integrated in the list of authorized applications with auto sign-in activated.</p>

<p><img src=public/images/doc/gmail_less_secure_captcha.png></p>

<h1>Installation on Heroku (for production) from a development server</h1>

<p>If you don&#39;t want to use the github integration method, an alternative option is possible</p>

<p>Install <a href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a></p>

<p>Or <a href="https://cli-assets.heroku.com/branches/stable/heroku-windows-amd64.exe">https://cli-assets.heroku.com/branches/stable/heroku-windows-amd64.exe</a></p>

<p>Open your local app directory in a git bash, and login to Heroku :</p>

<pre class="code ruby"><code class="ruby">$ cd /c/Sites/sharebox
$ heroku login
Enter your Heroku credentials:
Email: alexandre.cuer@cerema.fr
Password: *************
Logged in as alexandre.cuer@cerema.fr
</code></pre>

<p>Once succesfully logged, create a new heroku app :</p>

<pre class="code ruby"><code class="ruby">$ heroku create
Creating app... done, desolate-earth-32333
https://desolate-earth-32333.herokuapp.com/ | https://git.heroku.com/desolate-earth-32333.git
</code></pre>

<p>Heroku will define a random name for your production server, here : desolate-earth-32333.</p>

<p>Push the files with git.</p>

<pre class="code ruby"><code class="ruby">$ git init
$ git add .
$ git commit -a -m &quot;Switch to production&quot;
$ git push heroku master
</code></pre>

<p>Fix environmental variables (we assume you are using gmail)</p>

<pre class="code ruby"><code class="ruby">$ heroku config:set S3_BUCKET_NAME=&quot;your_bucket&quot;
$ heroku config:set AWS_REGION=&quot;your_region&quot;
$ heroku config:set AWS_HOST_NAME=&quot;your_host_name&quot;
$ heroku config:set AWS_URL=&quot;your_url&quot;
$ heroku config:set AWS_ACCESS_KEY_ID=&quot;your_access_key&quot;
$ heroku config:set AWS_SECRET_ACCESS_KEY=&quot;your_secret_access_key&quot;
$ heroku config:set GMAIL_USERNAME=&quot;your_gmail_address&quot;
$ heroku config:set GMAIL_PASSWORD=&quot;your_gmail_password&quot;
$ heroku config:set SMTP_ADDRESS=&quot;smtp.gmail.com&quot;
$ heroku config:set SMTP_PORT=587
$ heroku config:set DOMAIN=&quot;desolate-earth-32333.herokuapp.com&quot;
</code></pre>

<p>If for some reason, one variable is not correctly fixed, you can correct it from the heroku dashboard.</p>

<p>Go to <a href="https://dashboard.heroku.com/apps">https://dashboard.heroku.com/apps</a> &gt; Settings &gt; Reveal Config Vars</p>

<p>Create the database and the tables</p>

<pre class="code ruby"><code class="ruby">$ heroku run rake db:schema:load
</code></pre>

<h1>Working behind a proxy server</h1>

<p>If you work behind a proxy, please set http_proxy and https_proxy variables</p>

<pre class="code ruby"><code class="ruby">$ export https_proxy=&quot;http://user_name:password@proxy_url:proxy_port&quot;
$ export http_proxy=&quot;http://user_name:password@proxy_url:proxy_port&quot;
</code></pre>
</div></div>

      <div id="footer">
  Generated on Mon Oct  8 17:50:31 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.16 (ruby-2.3.3).
</div>

    </div>
  </body>
</html>